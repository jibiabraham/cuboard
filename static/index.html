<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Cube</title>
        <style>
            @import url(style.css);
        </style>
        <link rel="stylesheet" type="text/css" href="/vendor/css/bootstrap.css">
        <link rel="stylesheet" type="text/css" href="/vendor/css/bootstrap-responsive.css">
    </head>
    <body>
        <select id="step">
            <option value="1e4">10 seconds</option>
            <option value="6e4">1 minute</option>
            <option value="3e5">5 minutes</option>
        </select>

        <!-- Cubism and D3 files -->
        <script src="d3.v2.js"></script>
        <script src="/vendor/js/jquery-1.9.1.js"></script>
        <script src="/vendor/js/bootstrap.js"></script>
        <script src="/cubism/id.js"></script>
        <script src="/cubism/identity.js"></script>
        <script src="/cubism/cubism.js"></script>
        <script src="/cubism/option.js"></script>
        <script src="/cubism/context.js"></script>
        <script src="/cubism/cube.js"></script>
        <script src="/cubism/horizon.js"></script>
        <script src="/cubism/sum.js"></script>
        <script src="/cubism/rule.js"></script>
        <script src="/cubism/axis.js"></script>
        <script src="/cubism/metric.js"></script>
        <script src="/cubism/metric-constant.js"></script>
        <script src="/cubism/metric-operator.js"></script>

        <!-- Default graph sets from cube -->
        <script>
            //
            var step = +cubism.option("step", 1e4);

            //
            var context = cubism.context()
                .step(step)
                .size(1440);

            //
            var cube = context.cube();

            // Add top and bottom axes to display the time.
            d3.select("body").selectAll(".axis")
                .data(["top", "bottom"])
                .enter().append("div")
                .attr("class", function(d) { return d + " axis"; })
                .each(function(d) { d3.select(this).call(context.axis().ticks(12).orient(d)); });

            // Add a mouseover rule.
            d3.select("body").append("div")
                .attr("class", "rule")
                .call(context.rule());

            //
            d3.select("body").insert("div", ".bottom")
                .attr("class", "group")
                .call(function() { this.append("header").text("performance"); })
                .selectAll(".horizon")
                .data([
                    {title: "load", metric: cube.metric("sum(cube_compute(ms))").divide(step)},
                    {title: "median latency (ms)", metric: cube.metric("median(cube_compute(ms))")}
                ])
                .enter().append("div")
                .attr("class", "horizon")
                .call(context.horizon()
                .title(function(d) { return d.title; })
                .metric(function(d) { return d.metric; }));

            //
            d3.json("/1.0/types", function(types) {
                d3.select("body").insert("div", ".bottom")
                    .attr("class", "group")
                    .call(function() { this.append("header").text("incoming events (/s)"); })
                    .selectAll(".horizon")
                    .data(types)
                    .enter().append("div")
                    .attr("class", "horizon")
                    .call(context.horizon()
                    .metric(function(d) { return cube.metric("sum(" + d + ")").divide(step / 1e3); }));
            });

            // Setup a sum card
            d3.select("body").insert("div")
                .attr("class", "container")
                .append("div")
                .attr("class", "row sum")
                .selectAll(".row.sum")
                .data([
                    {title: "Request sum", metric: cube.metric("sum(request)")},
                    {title: "Home", metric: cube.metric("sum(request.re(uri,'/home'))")}
                ])
                .enter().append("div")
                .attr("class", "sum span2 text-center well")
                .call(
                    cubism.context().step(60 * 60 * 1000).sum()
                        .title(function(d){ return d.title; })
                        .metric(function(d){ return d.metric; })
                );

            // On mousemove, reposition the chart values to match the rule.
            context.on("focus", function(i) {
                d3.selectAll(".value").style("right", i == null ? null : context.size() - i + "px");
            });

            // Initialize the step menu's selection.
            d3.selectAll("#step option").property("selected", function() {
                return this.value == step;
            });

            // Update the location on step change.
            d3.select("#step").on("change", function() {
                window.location = "?step=" + this.value + "&" + location.search.replace(/[?&]step=[^&]*(&|$)/g, "$1").substring(1);
            });

        </script>
    </body>
</html>